<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
.r1 {color: #005f00; text-decoration-color: #005f00}
.r2 {font-weight: bold}
.r3 {color: #000080; text-decoration-color: #000080; font-weight: bold}
.r4 {color: #87af00; text-decoration-color: #87af00; font-weight: bold}
.r5 {color: #005f00; text-decoration-color: #005f00; font-weight: bold}
.r6 {color: #7f7f7f; text-decoration-color: #7f7f7f; font-weight: bold}
.r7 {color: #000080; text-decoration-color: #000080; font-weight: bold; font-style: italic}
.r8 {color: #87af00; text-decoration-color: #87af00; font-weight: bold; font-style: italic}
.r9 {color: #005f00; text-decoration-color: #005f00; font-weight: bold; font-style: italic}
.r10 {color: #7f7f7f; text-decoration-color: #7f7f7f}
.r11 {color: #000080; text-decoration-color: #000080}
.r12 {color: #87af00; text-decoration-color: #87af00}
.r13 {color: #ba2121; text-decoration-color: #ba2121; background-color: #f8f8f8; font-style: italic}
.r14 {background-color: #f8f8f8}
.r15 {color: #008000; text-decoration-color: #008000; background-color: #f8f8f8; font-weight: bold}
.r16 {color: #bbbbbb; text-decoration-color: #bbbbbb; background-color: #f8f8f8}
.r17 {color: #0000ff; text-decoration-color: #0000ff; background-color: #f8f8f8; font-weight: bold}
.r18 {color: #000000; text-decoration-color: #000000; background-color: #f8f8f8}
.r19 {color: #008000; text-decoration-color: #008000; background-color: #f8f8f8}
.r20 {color: #666666; text-decoration-color: #666666; background-color: #f8f8f8}
.r21 {color: #ba2121; text-decoration-color: #ba2121; background-color: #f8f8f8}
.r22 {color: #0000ff; text-decoration-color: #0000ff; background-color: #f8f8f8}
.r23 {color: #cb3f38; text-decoration-color: #cb3f38; background-color: #f8f8f8; font-weight: bold}
.r24 {color: #aa22ff; text-decoration-color: #aa22ff; background-color: #f8f8f8; font-weight: bold}
.r25 {color: #3d7b7b; text-decoration-color: #3d7b7b; background-color: #f8f8f8; font-style: italic}
.r26 {color: #800000; text-decoration-color: #800000; font-weight: bold}
.r27 {color: #19177c; text-decoration-color: #19177c; background-color: #f8f8f8}
.r28 {font-weight: bold; font-style: italic}
.r29 {color: #000080; text-decoration-color: #000080; text-decoration: underline}
body {
    color: #000000;
    background-color: #ffffff;
}
</style>
</head>
<body>
    <pre style="font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><code style="font-family:inherit">                          Memory usage: <span class="r1">▃▅▃▅▃▅▅▅▅▆▆▆▅▆▆▅▆▇▆▆▇▆▆▆▆▇▇</span> (max: 773.989 MB, growth rate:   0%)                           
            /home/luke/code/assignment1-basics/cs336_basics/bpe.py: % of time =  99.89% (2m:41.635s) out of 2m:41.743s.            
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/luke/code/assignment1-basics/cs336_basics/b… </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">&quot;&quot;&quot;Utility functions for training a Byte Pair Enco</span>  
 <span class="r10">    2 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">from</span><span class="r16"> </span><span class="r17">__future__</span><span class="r16"> </span><span class="r15">import</span><span class="r18"> annotations</span><span class="r14">                </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">import</span><span class="r16"> </span><span class="r17">os</span><span class="r14">                                         </span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">from</span><span class="r16"> </span><span class="r17">collections</span><span class="r16"> </span><span class="r15">import</span><span class="r18"> Counter, defaultdict</span><span class="r14">      </span>  
 <span class="r10">    7 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">from</span><span class="r16"> </span><span class="r17">collections.abc</span><span class="r16"> </span><span class="r15">import</span><span class="r18"> Iterable, Sequence</span><span class="r14">    </span>  
 <span class="r10">    8 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">from</span><span class="r16"> </span><span class="r17">functools</span><span class="r16"> </span><span class="r15">import</span><span class="r18"> partial</span><span class="r14">                     </span>  
 <span class="r10">    9 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">from</span><span class="r16"> </span><span class="r17">heapq</span><span class="r16"> </span><span class="r15">import</span><span class="r18"> heapify, heappop, heappush</span><span class="r14">      </span>  
 <span class="r10">   10 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">from</span><span class="r16"> </span><span class="r17">multiprocessing</span><span class="r16"> </span><span class="r15">import</span><span class="r18"> Pool, cpu_count</span><span class="r14">       </span>  
 <span class="r10">   11 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">from</span><span class="r16"> </span><span class="r17">pathlib</span><span class="r16"> </span><span class="r15">import</span><span class="r18"> Path</span><span class="r14">                          </span>  
 <span class="r10">   12 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">from</span><span class="r16"> </span><span class="r17">typing</span><span class="r16"> </span><span class="r15">import</span><span class="r18"> BinaryIO, Final, TypeAlias</span><span class="r14">     </span>  
 <span class="r10">   13 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   14 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">import</span><span class="r16"> </span><span class="r17">regex</span><span class="r16"> </span><span class="r15">as</span><span class="r16"> </span><span class="r17">re</span><span class="r14">                                </span>  
 <span class="r10">   15 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   16 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">from</span><span class="r16"> </span><span class="r17">.utility</span><span class="r16"> </span><span class="r15">import</span><span class="r18"> print_bpe_result, save_bpe_ms</span>  
 <span class="r10">   17 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   18 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">PATTERN: Final[</span><span class="r19">str</span><span class="r18">] </span><span class="r20">=</span><span class="r18"> (</span><span class="r14">                           </span>  
 <span class="r10">   19 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r21">r</span><span class="r13">&quot;&quot;&quot;&#x27;(?:[sdmt]|ll|ve|re)| ?\p{L}+| ?\p{N}+| ?[</span>  
 <span class="r10">   20 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">)</span><span class="r14">                                                 </span>  
 <span class="r10">   21 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">ENDOFTEXT: Final[</span><span class="r19">str</span><span class="r18">] </span><span class="r20">=</span><span class="r18"> </span><span class="r21">&quot;&lt;|endoftext|&gt;&quot;</span><span class="r14">           </span>  
 <span class="r10">   22 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   23 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">ChunkRange: TypeAlias </span><span class="r20">=</span><span class="r18"> </span><span class="r19">tuple</span><span class="r18">[</span><span class="r19">int</span><span class="r18">, </span><span class="r19">int</span><span class="r18">]</span><span class="r14">           </span>  
 <span class="r10">   24 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">MergePair: TypeAlias </span><span class="r20">=</span><span class="r18"> </span><span class="r19">tuple</span><span class="r18">[</span><span class="r19">int</span><span class="r18">, </span><span class="r19">int</span><span class="r18">]</span><span class="r14">            </span>  
 <span class="r10">   25 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">MergeHeapEntry: TypeAlias </span><span class="r20">=</span><span class="r18"> </span><span class="r19">tuple</span><span class="r18">[</span><span class="r19">int</span><span class="r18">, </span><span class="r19">tuple</span><span class="r18">[</span><span class="r19">int</span><span class="r18">, </span>  
 <span class="r10">   26 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">TokenIdSplit: TypeAlias </span><span class="r20">=</span><span class="r18"> </span><span class="r19">list</span><span class="r18">[</span><span class="r19">int</span><span class="r18">]</span><span class="r14">               </span>  
 <span class="r10">   27 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   28 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">_COMPILED_TOKEN_PATTERNS: </span><span class="r19">dict</span><span class="r18">[</span><span class="r19">str</span><span class="r18">, re</span><span class="r20">.</span><span class="r18">Pattern] </span><span class="r20">=</span><span class="r18"> </span>  
 <span class="r10">   29 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">_COMPILED_SPECIAL_SPLIT_PATTERNS: </span><span class="r19">dict</span><span class="r18">[</span><span class="r19">tuple</span><span class="r18">[</span><span class="r19">str</span><span class="r18">, </span>  
 <span class="r10">   30 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">_WORKER_REGEX_CACHE: </span><span class="r19">dict</span><span class="r18">[</span><span class="r19">str</span><span class="r18">, re</span><span class="r20">.</span><span class="r18">Pattern </span><span class="r20">|</span><span class="r18"> </span><span class="r15">None</span><span class="r18">] </span>  
 <span class="r10">   31 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   32 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">find_chunk_boundaries</span><span class="r18">(</span><span class="r14">                        </span>  
 <span class="r10">   34 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    file: BinaryIO,</span><span class="r14">                               </span>  
 <span class="r10">   35 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    desired_num_chunks: </span><span class="r19">int</span><span class="r18">,</span><span class="r14">                      </span>  
 <span class="r10">   36 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    split_special_token: </span><span class="r19">bytes</span><span class="r18">,</span><span class="r14">                   </span>  
 <span class="r10">   37 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">) </span><span class="r20">-&gt;</span><span class="r18"> </span><span class="r19">list</span><span class="r18">[</span><span class="r19">int</span><span class="r18">]:</span><span class="r14">                                   </span>  
 <span class="r10">   38 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Return sorted byte offsets for splitting a </span>  
 <span class="r10">   39 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   40 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">    Each chunk boundary is aligned with the first </span>  
 <span class="r10">   41 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">    `split_special_token` after the initial evenly</span>  
 <span class="r10">   42 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">    that chunks can be processed independently wit</span>  
 <span class="r10">   43 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">    The first boundary is always ``0`` and the las</span>  
 <span class="r10">   44 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">    &quot;&quot;&quot;</span><span class="r14">                                           </span>  
 <span class="r10">   45 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">if</span><span class="r18"> desired_num_chunks </span><span class="r20">&lt;=</span><span class="r18"> </span><span class="r20">0</span><span class="r18">:</span><span class="r14">                   </span>  
 <span class="r10">   46 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">raise</span><span class="r18"> </span><span class="r23">ValueError</span><span class="r18">(</span><span class="r21">&quot;desired_num_chunks must </span>  
 <span class="r10">   47 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">if</span><span class="r18"> </span><span class="r24">not</span><span class="r18"> </span><span class="r19">isinstance</span><span class="r18">(split_special_token, </span><span class="r19">bytes</span><span class="r18">):</span>  
 <span class="r10">   48 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">raise</span><span class="r18"> </span><span class="r23">TypeError</span><span class="r18">(</span><span class="r21">&quot;split_special_token must </span>  
 <span class="r10">   49 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   50 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    file</span><span class="r20">.</span><span class="r18">seek(</span><span class="r20">0</span><span class="r18">, os</span><span class="r20">.</span><span class="r18">SEEK_END)</span><span class="r14">                     </span>  
 <span class="r10">   51 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    file_size </span><span class="r20">=</span><span class="r18"> file</span><span class="r20">.</span><span class="r18">tell()</span><span class="r14">                       </span>  
 <span class="r10">   52 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    file</span><span class="r20">.</span><span class="r18">seek(</span><span class="r20">0</span><span class="r18">)</span><span class="r14">                                  </span>  
 <span class="r10">   53 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   54 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    chunk_size </span><span class="r20">=</span><span class="r18"> </span><span class="r19">max</span><span class="r18">(</span><span class="r20">1</span><span class="r18">, file_size </span><span class="r20">//</span><span class="r18"> desired_num_c</span>  
 <span class="r10">   55 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    chunk_boundaries </span><span class="r20">=</span><span class="r18"> [i </span><span class="r20">*</span><span class="r18"> chunk_size </span><span class="r15">for</span><span class="r18"> i </span><span class="r24">in</span><span class="r18"> </span><span class="r19">ra</span>  
 <span class="r10">   56 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    chunk_boundaries[</span><span class="r20">0</span><span class="r18">] </span><span class="r20">=</span><span class="r18"> </span><span class="r20">0</span><span class="r14">                       </span>  
 <span class="r10">   57 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    chunk_boundaries[</span><span class="r20">-1</span><span class="r18">] </span><span class="r20">=</span><span class="r18"> file_size</span><span class="r14">              </span>  
 <span class="r10">   58 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   59 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    read_ahead_bytes </span><span class="r20">=</span><span class="r18"> </span><span class="r20">4096</span><span class="r18">  </span><span class="r25"># Read ahead in reaso</span>  
 <span class="r10">   60 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   61 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">for</span><span class="r18"> idx </span><span class="r24">in</span><span class="r18"> </span><span class="r19">range</span><span class="r18">(</span><span class="r20">1</span><span class="r18">, </span><span class="r19">len</span><span class="r18">(chunk_boundaries) </span><span class="r20">-</span><span class="r18"> </span><span class="r20">1</span><span class="r18">)</span>  
 <span class="r10">   62 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        initial_position </span><span class="r20">=</span><span class="r18"> chunk_boundaries[idx]</span><span class="r14">  </span>  
 <span class="r10">   63 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        file</span><span class="r20">.</span><span class="r18">seek(initial_position)</span><span class="r14">               </span>  
 <span class="r10">   64 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">while</span><span class="r18"> </span><span class="r15">True</span><span class="r18">:</span><span class="r14">                               </span>  
 <span class="r10">   65 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">  2%   </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            read_window </span><span class="r20">=</span><span class="r18"> file</span><span class="r20">.</span><span class="r18">read(read_ahead_byt</span>  
 <span class="r10">   66 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            </span><span class="r15">if</span><span class="r18"> read_window </span><span class="r20">==</span><span class="r18"> </span><span class="r21">b&quot;&quot;</span><span class="r18">:</span><span class="r14">                </span>  
 <span class="r10">   67 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                chunk_boundaries[idx] </span><span class="r20">=</span><span class="r18"> file_size</span><span class="r14"> </span>  
 <span class="r10">   68 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                </span><span class="r15">break</span><span class="r14">                             </span>  
 <span class="r10">   69 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   70 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            found_at </span><span class="r20">=</span><span class="r18"> read_window</span><span class="r20">.</span><span class="r18">find(split_spec</span>  
 <span class="r10">   71 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            </span><span class="r15">if</span><span class="r18"> found_at </span><span class="r20">!=</span><span class="r18"> </span><span class="r20">-1</span><span class="r18">:</span><span class="r14">                    </span>  
 <span class="r10">   72 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                chunk_boundaries[idx] </span><span class="r20">=</span><span class="r18"> initial_po</span>  
 <span class="r10">   73 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                </span><span class="r15">break</span><span class="r14">                             </span>  
 <span class="r10">   74 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            initial_position </span><span class="r20">+=</span><span class="r18"> read_ahead_bytes</span><span class="r14">  </span>  
 <span class="r10">   75 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   76 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">return</span><span class="r18"> </span><span class="r19">sorted</span><span class="r18">(</span><span class="r19">set</span><span class="r18">(chunk_boundaries))</span><span class="r14">          </span>  
 <span class="r10">   77 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   78 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   79 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">train_bpe</span><span class="r18">(</span><span class="r14">                                    </span>  
 <span class="r10">   80 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    input_path: </span><span class="r19">str</span><span class="r18"> </span><span class="r20">|</span><span class="r18"> os</span><span class="r20">.</span><span class="r18">PathLike[</span><span class="r19">str</span><span class="r18">],</span><span class="r14">           </span>  
 <span class="r10">   81 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    vocab_size: </span><span class="r19">int</span><span class="r18"> </span><span class="r20">=</span><span class="r18"> </span><span class="r20">270</span><span class="r18">,</span><span class="r14">                        </span>  
 <span class="r10">   82 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    special_tokens: Sequence[</span><span class="r19">str</span><span class="r18">] </span><span class="r20">|</span><span class="r18"> </span><span class="r15">None</span><span class="r18"> </span><span class="r20">=</span><span class="r18"> </span><span class="r15">None</span><span class="r18">,</span><span class="r14">  </span>  
 <span class="r10">   83 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    num_workers: </span><span class="r19">int</span><span class="r18"> </span><span class="r20">|</span><span class="r18"> </span><span class="r15">None</span><span class="r18"> </span><span class="r20">=</span><span class="r18"> </span><span class="r15">None</span><span class="r18">,</span><span class="r14">               </span>  
 <span class="r10">   84 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pattern: </span><span class="r19">str</span><span class="r18"> </span><span class="r20">=</span><span class="r18"> PATTERN,</span><span class="r14">                       </span>  
 <span class="r10">   85 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    save: </span><span class="r19">bool</span><span class="r18"> </span><span class="r20">=</span><span class="r18"> </span><span class="r15">False</span><span class="r18">,</span><span class="r14">                           </span>  
 <span class="r10">   86 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">) </span><span class="r20">-&gt;</span><span class="r18"> </span><span class="r19">tuple</span><span class="r18">[</span><span class="r19">dict</span><span class="r18">[</span><span class="r19">int</span><span class="r18">, </span><span class="r19">bytes</span><span class="r18">], </span><span class="r19">list</span><span class="r18">[</span><span class="r19">tuple</span><span class="r18">[</span><span class="r19">bytes</span><span class="r18">, </span><span class="r19">byt</span>  
 <span class="r10">   87 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Train a simple BPE vocabulary from the prov</span>  
 <span class="r10">   88 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   89 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">    Args:</span><span class="r14">                                         </span>  
 <span class="r10">   90 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">        input_path: Path to the training corpus (U</span>  
 <span class="r10">   91 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">        vocab_size: Target vocabulary size includi</span>  
 <span class="r10">   92 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">        special_tokens: Optional additional tokens</span>  
 <span class="r10">   93 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">            the vocabulary.</span><span class="r14">                       </span>  
 <span class="r10">   94 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">        num_workers: Optional worker count for mul</span>  
 <span class="r10">   95 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">            the CPU count, but never exceeds the n</span>  
 <span class="r10">   96 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">        pattern: Regular expression used for pre-t</span>  
 <span class="r10">   97 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">        save: Whether to store the resulting token</span>  
 <span class="r10">   98 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">   99 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">    Returns:</span><span class="r14">                                      </span>  
 <span class="r10">  100 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">        A tuple ``(vocab, merges)`` where:</span><span class="r14">        </span>  
 <span class="r10">  101 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">            * ``vocab`` maps token indices to thei</span>  
 <span class="r10">  102 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">            * ``merges`` captures the ordered sequ</span>  
 <span class="r10">  103 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">    &quot;&quot;&quot;</span><span class="r14">                                           </span>  
 <span class="r10">  104 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    resolved_special_tokens </span><span class="r20">=</span><span class="r18"> _normalize_special_t</span>  
 <span class="r10">  105 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  106 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">with</span><span class="r18"> </span><span class="r19">open</span><span class="r18">(input_path, </span><span class="r21">&quot;rb&quot;</span><span class="r18">) </span><span class="r15">as</span><span class="r18"> file:</span><span class="r14">          </span>  
 <span class="r10">  107 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        boundaries </span><span class="r20">=</span><span class="r18"> find_chunk_boundaries(</span><span class="r14">       </span>  
 <span class="r10">  108 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            file, _effective_worker_count(num_work</span>  
 <span class="r10">  109 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        )</span><span class="r14">                                         </span>  
 <span class="r10">  110 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    chunk_ranges: </span><span class="r19">list</span><span class="r18">[ChunkRange] </span><span class="r20">=</span><span class="r18"> </span><span class="r19">list</span><span class="r18">(</span><span class="r19">zip</span><span class="r18">(boun</span>  
 <span class="r10">  111 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    num_ranges </span><span class="r20">=</span><span class="r18"> </span><span class="r19">len</span><span class="r18">(chunk_ranges)</span><span class="r14">                </span>  
 <span class="r10">  112 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    worker_count </span><span class="r20">=</span><span class="r18"> _effective_worker_count(num_wor</span>  
 <span class="r10">  113 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pre_token_counts </span><span class="r20">=</span><span class="r18"> _collect_pre_token_counts_f</span>  
 <span class="r10">  114 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r19">str</span><span class="r18">(input_path), chunk_ranges, resolved_sp</span>  
 <span class="r10">  115 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    )</span><span class="r14">                                             </span>  
 <span class="r10">  116 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  117 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    vocab_list </span><span class="r20">=</span><span class="r18"> _build_initial_vocab(resolved_spe</span>  
 <span class="r10">  118 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    vocab_lexkey </span><span class="r20">=</span><span class="r18"> [_lexkey(tok) </span><span class="r15">for</span><span class="r18"> tok </span><span class="r24">in</span><span class="r18"> vocab_</span>  
 <span class="r10">  119 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  120 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair_counts, token_splits, pair_to_tokens, pai</span>  
 <span class="r10">  121 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        pre_token_counts,</span><span class="r14">                         </span>  
 <span class="r10">  122 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r19">len</span><span class="r18">(resolved_special_tokens),</span><span class="r14">             </span>  
 <span class="r10">  123 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    )</span><span class="r14">                                             </span>  
 <span class="r10">  124 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    merge_candidate_heap: </span><span class="r19">list</span><span class="r18">[MergeHeapEntry] </span><span class="r20">=</span><span class="r18"> _</span>  
 <span class="r10">  125 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        pair_counts, vocab_lexkey</span><span class="r14">                 </span>  
 <span class="r10">  126 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    )</span><span class="r14">                                             </span>  
 <span class="r10">  127 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  128 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    merged_index_pairs: </span><span class="r19">list</span><span class="r18">[MergePair] </span><span class="r20">=</span><span class="r18"> []</span><span class="r14">      </span>  
 <span class="r10">  129 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">while</span><span class="r18"> </span><span class="r19">len</span><span class="r18">(vocab_list) </span><span class="r20">&lt;</span><span class="r18"> vocab_size:</span><span class="r14">           </span>  
 <span class="r10">  130 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        pair_to_merge: MergePair </span><span class="r20">|</span><span class="r18"> </span><span class="r15">None</span><span class="r18"> </span><span class="r20">=</span><span class="r18"> _select_</span>  
 <span class="r10">  131 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            merge_candidate_heap, pair_version</span><span class="r14">    </span>  
 <span class="r10">  132 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        )</span><span class="r14">                                         </span>  
 <span class="r10">  133 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">if</span><span class="r18"> pair_to_merge </span><span class="r24">is</span><span class="r18"> </span><span class="r15">None</span><span class="r18">:</span><span class="r14">                 </span>  
 <span class="r10">  134 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            </span><span class="r15">break</span><span class="r14">                                 </span>  
 <span class="r10">  135 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        new_token_id </span><span class="r20">=</span><span class="r18"> </span><span class="r19">len</span><span class="r18">(vocab_list)</span><span class="r14">            </span>  
 <span class="r10">  136 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        new_token </span><span class="r20">=</span><span class="r18"> vocab_list[pair_to_merge[</span><span class="r20">0</span><span class="r18">]] </span><span class="r20">+</span>  
 <span class="r10">  137 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        vocab_list</span><span class="r20">.</span><span class="r18">append(new_token)</span><span class="r14">              </span>  
 <span class="r10">  138 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        vocab_lexkey</span><span class="r20">.</span><span class="r18">append(_lexkey(new_token))</span><span class="r14">   </span>  
 <span class="r10">  139 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        _apply_merge(</span><span class="r14">                             </span>  
 <span class="r10">  140 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            new_token_id,</span><span class="r14">                         </span>  
 <span class="r10">  141 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            pair_to_merge,</span><span class="r14">                        </span>  
 <span class="r10">  142 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            pair_to_tokens,</span><span class="r14">                       </span>  
 <span class="r10">  143 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            pre_token_counts,</span><span class="r14">                     </span>  
 <span class="r10">  144 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            token_splits,</span><span class="r14">                         </span>  
 <span class="r10">  145 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            pair_counts,</span><span class="r14">                          </span>  
 <span class="r10">  146 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            pair_version,</span><span class="r14">                         </span>  
 <span class="r10">  147 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            merge_candidate_heap,</span><span class="r14">                 </span>  
 <span class="r10">  148 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            vocab_lexkey,</span><span class="r14">                         </span>  
 <span class="r10">  149 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        )</span><span class="r14">                                         </span>  
 <span class="r10">  150 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        merged_index_pairs</span><span class="r20">.</span><span class="r18">append(pair_to_merge)</span><span class="r14">  </span>  
 <span class="r10">  151 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  152 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    vocab </span><span class="r20">=</span><span class="r18"> {idx: token </span><span class="r15">for</span><span class="r18"> idx, token </span><span class="r24">in</span><span class="r18"> </span><span class="r19">enumerat</span>  
 <span class="r10">  153 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    merges </span><span class="r20">=</span><span class="r18"> [(vocab_list[i], vocab_list[j]) </span><span class="r15">for</span><span class="r18"> i</span>  
 <span class="r10">  154 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  155 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">if</span><span class="r18"> save:</span><span class="r14">                                      </span>  
 <span class="r10">  156 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        base_path </span><span class="r20">=</span><span class="r18"> Path(input_path)</span><span class="r14">              </span>  
 <span class="r10">  157 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        out_path </span><span class="r20">=</span><span class="r18"> base_path</span><span class="r20">.</span><span class="r18">parent </span><span class="r20">/</span><span class="r18"> </span><span class="r21">&quot;tokenizer.m</span>  
 <span class="r10">  158 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        save_bpe_msgpack(vocab, merges, out_path)</span><span class="r14"> </span>  
 <span class="r10">  159 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  160 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">return</span><span class="r18"> vocab, merges</span><span class="r14">                          </span>  
 <span class="r10">  161 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  162 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  163 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">_lexkey</span><span class="r18">(token_bytes: </span><span class="r19">bytes</span><span class="r18">) </span><span class="r20">-&gt;</span><span class="r18"> </span><span class="r19">tuple</span><span class="r18">[</span><span class="r19">int</span><span class="r18">, </span><span class="r20">...</span><span class="r18">]</span>  
 <span class="r10">  164 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Return a lexical ordering key used for heap</span>  
 <span class="r10">  165 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">return</span><span class="r18"> </span><span class="r19">tuple</span><span class="r18">(</span><span class="r20">255</span><span class="r18"> </span><span class="r20">-</span><span class="r18"> b </span><span class="r15">for</span><span class="r18"> b </span><span class="r24">in</span><span class="r18"> token_bytes) </span><span class="r20">+</span><span class="r18"> (</span>  
 <span class="r10">  166 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  167 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  168 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">_normalize_special_tokens</span><span class="r18">(tokens: Sequence[</span><span class="r19">str</span>  
 <span class="r10">  169 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Return a de-duplicated, ordered list of spe</span>  
 <span class="r10">  170 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  171 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">if</span><span class="r18"> </span><span class="r24">not</span><span class="r18"> tokens:</span><span class="r14">                                </span>  
 <span class="r10">  172 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">return</span><span class="r18"> [ENDOFTEXT]</span><span class="r14">                        </span>  
 <span class="r10">  173 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  174 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">return</span><span class="r18"> </span><span class="r19">list</span><span class="r18">(</span><span class="r19">dict</span><span class="r20">.</span><span class="r18">fromkeys(tokens))</span><span class="r14">            </span>  
 <span class="r10">  175 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  176 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  177 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">_effective_worker_count</span><span class="r18">(</span><span class="r14">                      </span>  
 <span class="r10">  178 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    num_workers: </span><span class="r19">int</span><span class="r18"> </span><span class="r20">|</span><span class="r18"> </span><span class="r15">None</span><span class="r18">, num_chunks: </span><span class="r19">int</span><span class="r18"> </span><span class="r20">|</span><span class="r18"> </span><span class="r15">Non</span>  
 <span class="r10">  179 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">) </span><span class="r20">-&gt;</span><span class="r18"> </span><span class="r19">int</span><span class="r18">:</span><span class="r14">                                         </span>  
 <span class="r10">  180 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Pick a worker count that respects CPU avail</span>  
 <span class="r10">  181 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    available </span><span class="r20">=</span><span class="r18"> </span><span class="r19">max</span><span class="r18">(</span><span class="r20">1</span><span class="r18">, cpu_count() </span><span class="r20">-</span><span class="r18"> </span><span class="r20">1</span><span class="r18">)</span><span class="r14">           </span>  
 <span class="r10">  182 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    capped </span><span class="r20">=</span><span class="r18"> </span><span class="r19">min</span><span class="r18">(num_workers </span><span class="r24">or</span><span class="r18"> available, availab</span>  
 <span class="r10">  183 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">if</span><span class="r18"> num_chunks </span><span class="r24">is</span><span class="r18"> </span><span class="r24">not</span><span class="r18"> </span><span class="r15">None</span><span class="r18">:</span><span class="r14">                    </span>  
 <span class="r10">  184 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        capped </span><span class="r20">=</span><span class="r18"> </span><span class="r19">min</span><span class="r18">(capped, </span><span class="r19">max</span><span class="r18">(</span><span class="r20">1</span><span class="r18">, num_chunks))</span><span class="r14">  </span>  
 <span class="r10">  185 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">return</span><span class="r18"> </span><span class="r19">max</span><span class="r18">(</span><span class="r20">1</span><span class="r18">, capped)</span><span class="r14">                         </span>  
 <span class="r10">  186 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  187 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  188 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">_get_or_compile_pattern</span><span class="r18">(pattern: </span><span class="r19">str</span><span class="r18">) </span><span class="r20">-&gt;</span><span class="r18"> re</span><span class="r20">.</span><span class="r18">Pa</span>  
 <span class="r10">  189 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Return a cached regex pattern for the provi</span>  
 <span class="r10">  190 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">return</span><span class="r18"> _COMPILED_TOKEN_PATTERNS</span><span class="r20">.</span><span class="r18">setdefault(pat</span>  
 <span class="r10">  191 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  192 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  193 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">_get_or_compile_special_split_pattern</span><span class="r18">(</span><span class="r14">        </span>  
 <span class="r10">  194 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    special_tokens: Sequence[</span><span class="r19">str</span><span class="r18">],</span><span class="r14">                </span>  
 <span class="r10">  195 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">) </span><span class="r20">-&gt;</span><span class="r18"> re</span><span class="r20">.</span><span class="r18">Pattern </span><span class="r20">|</span><span class="r18"> </span><span class="r15">None</span><span class="r18">:</span><span class="r14">                           </span>  
 <span class="r10">  196 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Return a cached regex that isolates special</span>  
 <span class="r10">  197 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">if</span><span class="r18"> </span><span class="r24">not</span><span class="r18"> special_tokens:</span><span class="r14">                        </span>  
 <span class="r10">  198 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">return</span><span class="r18"> </span><span class="r15">None</span><span class="r14">                               </span>  
 <span class="r10">  199 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    joined </span><span class="r20">=</span><span class="r18"> </span><span class="r21">&quot;|&quot;</span><span class="r20">.</span><span class="r18">join(re</span><span class="r20">.</span><span class="r18">escape(token) </span><span class="r15">for</span><span class="r18"> token </span><span class="r24">i</span>  
 <span class="r10">  200 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    key </span><span class="r20">=</span><span class="r18"> (joined, </span><span class="r19">tuple</span><span class="r18">(special_tokens))</span><span class="r14">         </span>  
 <span class="r10">  201 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">return</span><span class="r18"> _COMPILED_SPECIAL_SPLIT_PATTERNS</span><span class="r20">.</span><span class="r18">setdef</span>  
 <span class="r10">  202 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  203 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  204 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">_collect_pre_token_counts_from_ranges</span><span class="r18">(</span><span class="r14">        </span>  
 <span class="r10">  205 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    input_path: </span><span class="r19">str</span><span class="r18">,</span><span class="r14">                              </span>  
 <span class="r10">  206 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    chunk_ranges: Sequence[ChunkRange],</span><span class="r14">           </span>  
 <span class="r10">  207 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    special_tokens: Sequence[</span><span class="r19">str</span><span class="r18">],</span><span class="r14">                </span>  
 <span class="r10">  208 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pattern: </span><span class="r19">str</span><span class="r18">,</span><span class="r14">                                 </span>  
 <span class="r10">  209 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    worker_count: </span><span class="r19">int</span><span class="r18">,</span><span class="r14">                            </span>  
 <span class="r10">  210 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    chunksize: </span><span class="r19">int</span><span class="r18"> </span><span class="r20">|</span><span class="r18"> </span><span class="r15">None</span><span class="r18"> </span><span class="r20">=</span><span class="r18"> </span><span class="r15">None</span><span class="r18">,</span><span class="r14">                 </span>  
 <span class="r10">  211 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">) </span><span class="r20">-&gt;</span><span class="r18"> Counter[</span><span class="r19">bytes</span><span class="r18">]:</span><span class="r14">                              </span>  
 <span class="r10">  212 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Pre-tokenise designated byte ranges in work</span>  
 <span class="r10">  213 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  214 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">    Each task receives only offsets and small meta</span>  
 <span class="r10">  215 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">    pickling and IPC overhead compared to sending </span>  
 <span class="r10">  216 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">    &quot;&quot;&quot;</span><span class="r14">                                           </span>  
 <span class="r10">  217 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">if</span><span class="r18"> </span><span class="r24">not</span><span class="r18"> chunk_ranges:</span><span class="r14">                          </span>  
 <span class="r10">  218 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">return</span><span class="r18"> Counter()</span><span class="r14">                          </span>  
 <span class="r10">  219 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  220 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    num_ranges </span><span class="r20">=</span><span class="r18"> </span><span class="r19">len</span><span class="r18">(chunk_ranges)</span><span class="r14">                </span>  
 <span class="r10">  221 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    worker_func </span><span class="r20">=</span><span class="r18"> partial(_process_range_for_preto</span>  
 <span class="r10">  222 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">if</span><span class="r18"> chunksize </span><span class="r24">is</span><span class="r18"> </span><span class="r15">None</span><span class="r18">:</span><span class="r14">                         </span>  
 <span class="r10">  223 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">if</span><span class="r18"> worker_count </span><span class="r20">&gt;=</span><span class="r18"> num_ranges:</span><span class="r14">            </span>  
 <span class="r10">  224 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            chunksize </span><span class="r20">=</span><span class="r18"> </span><span class="r20">1</span><span class="r14">                         </span>  
 <span class="r10">  225 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">else</span><span class="r18">:</span><span class="r14">                                     </span>  
 <span class="r10">  226 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            base </span><span class="r20">=</span><span class="r18"> </span><span class="r19">max</span><span class="r18">(</span><span class="r20">1</span><span class="r18">, num_ranges </span><span class="r20">//</span><span class="r18"> (worker_co</span>  
 <span class="r10">  227 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            chunksize </span><span class="r20">=</span><span class="r18"> </span><span class="r19">min</span><span class="r18">(</span><span class="r20">256</span><span class="r18">, base)</span><span class="r14">            </span>  
 <span class="r10">  228 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  229 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    aggregated: Counter[</span><span class="r19">bytes</span><span class="r18">] </span><span class="r20">=</span><span class="r18"> Counter()</span><span class="r14">        </span>  
 <span class="r10">  230 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">  1%   </span>│<span class="r1">  92%  </span>│<span class="r1">   10M </span>│<span class="r1">▁              </span>│<span class="r12">     2 </span>│<span class="r18">    </span><span class="r15">with</span><span class="r18"> Pool(</span><span class="r14">                                    </span>  
 <span class="r10">  231 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        processes</span><span class="r20">=</span><span class="r18">worker_count,</span><span class="r14">                   </span>  
 <span class="r10">  232 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        initializer</span><span class="r20">=</span><span class="r18">_initialize_worker_regex_cache</span>  
 <span class="r10">  233 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        initargs</span><span class="r20">=</span><span class="r18">(</span><span class="r19">tuple</span><span class="r18">(special_tokens), pattern),</span>  
 <span class="r10">  234 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    ) </span><span class="r15">as</span><span class="r18"> pool:</span><span class="r14">                                    </span>  
 <span class="r10">  235 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">for</span><span class="r18"> counter </span><span class="r24">in</span><span class="r18"> pool</span><span class="r20">.</span><span class="r18">imap_unordered(</span><span class="r14">       </span>  
 <span class="r10">  236 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            worker_func, chunk_ranges, chunksize</span><span class="r20">=</span><span class="r18">c</span>  
 <span class="r10">  237 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        ):</span><span class="r14">                                        </span>  
 <span class="r10">  238 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            aggregated</span><span class="r20">.</span><span class="r18">update(counter)</span><span class="r14">            </span>  
 <span class="r10">  239 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">return</span><span class="r18"> aggregated</span><span class="r14">                             </span>  
 <span class="r10">  240 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  241 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  242 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">_initialize_worker_regex_cache</span><span class="r18">(special_tokens:</span>  
 <span class="r10">  243 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Cache frequently reused regex objects insid</span>  
 <span class="r10">  244 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    special_split_re </span><span class="r20">=</span><span class="r18"> _get_or_compile_special_spl</span>  
 <span class="r10">  245 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pattern_re </span><span class="r20">=</span><span class="r18"> _get_or_compile_pattern(pattern)</span><span class="r14"> </span>  
 <span class="r10">  246 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    _WORKER_REGEX_CACHE[</span><span class="r21">&quot;special&quot;</span><span class="r18">] </span><span class="r20">=</span><span class="r18"> special_split</span>  
 <span class="r10">  247 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    _WORKER_REGEX_CACHE[</span><span class="r21">&quot;pattern&quot;</span><span class="r18">] </span><span class="r20">=</span><span class="r18"> pattern_re</span><span class="r14">   </span>  
 <span class="r10">  248 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  249 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  250 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">_process_range_for_pretokenization</span><span class="r18">(</span><span class="r14">           </span>  
 <span class="r10">  251 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    path: </span><span class="r19">str</span><span class="r18">, offset_span: ChunkRange</span><span class="r14">            </span>  
 <span class="r10">  252 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">) </span><span class="r20">-&gt;</span><span class="r18"> Counter[</span><span class="r19">bytes</span><span class="r18">]:</span><span class="r14">                              </span>  
 <span class="r10">  253 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Worker helper: read a byte span and emit re</span>  
 <span class="r10">  254 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    start, end </span><span class="r20">=</span><span class="r18"> offset_span</span><span class="r14">                      </span>  
 <span class="r10">  255 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">  4%   </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">with</span><span class="r18"> </span><span class="r19">open</span><span class="r18">(path, </span><span class="r21">&quot;rb&quot;</span><span class="r18">) </span><span class="r15">as</span><span class="r18"> f:</span><span class="r14">                   </span>  
 <span class="r10">  256 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        f</span><span class="r20">.</span><span class="r18">seek(start)</span><span class="r14">                             </span>  
 <span class="r10">  257 </span>│<span class="r11">       </span>│<span class="r11">    1% </span>│<span class="r11">  11% </span>│<span class="r12">  4%   </span>│<span class="r1"> 100%  </span>│<span class="r1">  774M </span>│<span class="r1">▇▅▇▄▅▂▇▅▄  79% </span>│<span class="r12">       </span>│<span class="r18">        data </span><span class="r20">=</span><span class="r18"> f</span><span class="r20">.</span><span class="r18">read(end </span><span class="r20">-</span><span class="r18"> start)</span><span class="r20">.</span><span class="r18">decode(</span><span class="r21">&quot;utf-8&quot;</span><span class="r18">,</span>  
 <span class="r10">  258 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  259 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">  5%   </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pre_tokens: Counter[</span><span class="r19">bytes</span><span class="r18">] </span><span class="r20">=</span><span class="r18"> Counter()</span><span class="r14">        </span>  
 <span class="r10">  260 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    special_split_re </span><span class="r20">=</span><span class="r18"> _WORKER_REGEX_CACHE[</span><span class="r21">&quot;specia</span>  
 <span class="r10">  261 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pattern_re </span><span class="r20">=</span><span class="r18"> _WORKER_REGEX_CACHE[</span><span class="r21">&quot;pattern&quot;</span><span class="r18">]</span><span class="r14">   </span>  
 <span class="r10">  262 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">assert</span><span class="r18"> pattern_re </span><span class="r24">is</span><span class="r18"> </span><span class="r24">not</span><span class="r18"> </span><span class="r15">None</span><span class="r14">                 </span>  
 <span class="r10">  263 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  264 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">   2% </span>│<span class="r12">  6%   </span>│<span class="r1">  91%  </span>│<span class="r1">  200M </span>│<span class="r1">▁▁▁▁▂▂▂▂▂  20% </span>│<span class="r12">       </span>│<span class="r18">    segments </span><span class="r20">=</span><span class="r18"> special_split_re</span><span class="r20">.</span><span class="r18">split(data) </span><span class="r15">if</span><span class="r18"> spe</span>  
 <span class="r10">  265 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">for</span><span class="r18"> segment </span><span class="r24">in</span><span class="r18"> segments:</span><span class="r14">                      </span>  
 <span class="r10">  266 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">if</span><span class="r18"> </span><span class="r24">not</span><span class="r18"> segment:</span><span class="r14">                           </span>  
 <span class="r10">  267 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">  3%   </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            </span><span class="r15">continue</span><span class="r14">                              </span>  
 <span class="r10">  268 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">  8%   </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     1 </span>│<span class="r18">        pre_tokens</span><span class="r20">.</span><span class="r18">update(</span><span class="r14">                        </span>  
 <span class="r10">  269 </span>│<span class="r26">   60%</span><span class="r11"> </span>│<span class="r26">    4%</span><span class="r11"> </span>│<span class="r11">  19% </span>│<span class="r26">  9%</span><span class="r12">   </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">   115 </span>│<span class="r18">            </span><span class="r15">match</span><span class="r20">.</span><span class="r18">group(</span><span class="r20">0</span><span class="r18">)</span><span class="r20">.</span><span class="r18">encode(</span><span class="r21">&quot;utf-8&quot;</span><span class="r18">) </span><span class="r15">for</span><span class="r18"> mat</span>  
 <span class="r10">  270 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        )</span><span class="r14">                                         </span>  
 <span class="r10">  271 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">return</span><span class="r18"> pre_tokens</span><span class="r14">                             </span>  
 <span class="r10">  272 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  273 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  274 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">_build_initial_vocab</span><span class="r18">(special_tokens: Iterable[</span>  
 <span class="r10">  275 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Construct the starting vocabulary of specia</span>  
 <span class="r10">  276 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">return</span><span class="r18"> [token</span><span class="r20">.</span><span class="r18">encode(</span><span class="r21">&quot;utf-8&quot;</span><span class="r18">) </span><span class="r15">for</span><span class="r18"> token </span><span class="r24">in</span><span class="r18"> spe</span>  
 <span class="r10">  277 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r19">bytes</span><span class="r18">([byte]) </span><span class="r15">for</span><span class="r18"> byte </span><span class="r24">in</span><span class="r18"> </span><span class="r19">range</span><span class="r18">(</span><span class="r20">256</span><span class="r18">)</span><span class="r14">      </span>  
 <span class="r10">  278 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    ]</span><span class="r14">                                             </span>  
 <span class="r10">  279 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  280 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  281 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">_initialize_pair_statistics</span><span class="r18">(</span><span class="r14">                  </span>  
 <span class="r10">  282 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pre_token_counts: Counter[</span><span class="r19">bytes</span><span class="r18">], symbol_offse</span>  
 <span class="r10">  283 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">) </span><span class="r20">-&gt;</span><span class="r18"> </span><span class="r19">tuple</span><span class="r18">[</span><span class="r14">                                       </span>  
 <span class="r10">  284 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    Counter[MergePair],</span><span class="r14">                           </span>  
 <span class="r10">  285 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r19">dict</span><span class="r18">[</span><span class="r19">bytes</span><span class="r18">, TokenIdSplit],</span><span class="r14">                    </span>  
 <span class="r10">  286 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r19">dict</span><span class="r18">[MergePair, </span><span class="r19">set</span><span class="r18">[</span><span class="r19">bytes</span><span class="r18">]],</span><span class="r14">                  </span>  
 <span class="r10">  287 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r19">dict</span><span class="r18">[MergePair, </span><span class="r19">int</span><span class="r18">],</span><span class="r14">                         </span>  
 <span class="r10">  288 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">]:</span><span class="r14">                                                </span>  
 <span class="r10">  289 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Initialize pair statistics used by the merg</span>  
 <span class="r10">  290 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair_counts: Counter[MergePair] </span><span class="r20">=</span><span class="r18"> Counter()</span><span class="r14">   </span>  
 <span class="r10">  291 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    token_splits: </span><span class="r19">dict</span><span class="r18">[</span><span class="r19">bytes</span><span class="r18">, TokenIdSplit] </span><span class="r20">=</span><span class="r18"> {}</span><span class="r14">  </span>  
 <span class="r10">  292 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair_to_tokens: </span><span class="r19">dict</span><span class="r18">[MergePair, </span><span class="r19">set</span><span class="r18">[</span><span class="r19">bytes</span><span class="r18">]] </span><span class="r20">=</span><span class="r18"> </span>  
 <span class="r10">  293 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair_version: </span><span class="r19">dict</span><span class="r18">[MergePair, </span><span class="r19">int</span><span class="r18">] </span><span class="r20">=</span><span class="r18"> defaultdi</span>  
 <span class="r10">  294 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  295 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">for</span><span class="r18"> token_bytes, frequency </span><span class="r24">in</span><span class="r18"> pre_token_counts</span>  
 <span class="r10">  296 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        split_int: TokenIdSplit </span><span class="r20">=</span><span class="r18"> [b </span><span class="r20">+</span><span class="r18"> symbol_offs</span>  
 <span class="r10">  297 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        token_splits[token_bytes] </span><span class="r20">=</span><span class="r18"> split_int</span><span class="r14">     </span>  
 <span class="r10">  298 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">for</span><span class="r18"> idx </span><span class="r24">in</span><span class="r18"> </span><span class="r19">range</span><span class="r18">(</span><span class="r19">len</span><span class="r18">(split_int) </span><span class="r20">-</span><span class="r18"> </span><span class="r20">1</span><span class="r18">):</span><span class="r14">     </span>  
 <span class="r10">  299 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            pair: MergePair </span><span class="r20">=</span><span class="r18"> (split_int[idx], spl</span>  
 <span class="r10">  300 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            pair_counts[pair] </span><span class="r20">+=</span><span class="r18"> frequency</span><span class="r14">        </span>  
 <span class="r10">  301 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            pair_to_tokens[pair]</span><span class="r20">.</span><span class="r18">add(token_bytes)</span><span class="r14"> </span>  
 <span class="r10">  302 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  303 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">return</span><span class="r18"> pair_counts, token_splits, pair_to_toke</span>  
 <span class="r10">  304 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  305 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  306 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">_build_merge_candidate_heap</span><span class="r18">(</span><span class="r14">                  </span>  
 <span class="r10">  307 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair_counts: Counter[MergePair],</span><span class="r14">              </span>  
 <span class="r10">  308 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    vocab_lexkey: Sequence[</span><span class="r19">tuple</span><span class="r18">[</span><span class="r19">int</span><span class="r18">, </span><span class="r20">...</span><span class="r18">]],</span><span class="r14">      </span>  
 <span class="r10">  309 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">) </span><span class="r20">-&gt;</span><span class="r18"> </span><span class="r19">list</span><span class="r18">[MergeHeapEntry]:</span><span class="r14">                        </span>  
 <span class="r10">  310 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Populate a heap of merge candidates ordered</span>  
 <span class="r10">  311 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    merge_candidate_heap </span><span class="r20">=</span><span class="r18"> [</span><span class="r14">                      </span>  
 <span class="r10">  312 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        (</span><span class="r20">-</span><span class="r18">freq, vocab_lexkey[a], vocab_lexkey[b], </span>  
 <span class="r10">  313 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">for</span><span class="r18"> (a, b), freq </span><span class="r24">in</span><span class="r18"> pair_counts</span><span class="r20">.</span><span class="r18">items()</span><span class="r14">   </span>  
 <span class="r10">  314 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">if</span><span class="r18"> freq </span><span class="r20">&gt;</span><span class="r18"> </span><span class="r20">0</span><span class="r14">                               </span>  
 <span class="r10">  315 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    ]</span><span class="r14">                                             </span>  
 <span class="r10">  316 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    heapify(merge_candidate_heap)</span><span class="r14">                 </span>  
 <span class="r10">  317 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">return</span><span class="r18"> merge_candidate_heap</span><span class="r14">                   </span>  
 <span class="r10">  318 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  319 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  320 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">_select_most_frequent_pair</span><span class="r18">(</span><span class="r14">                   </span>  
 <span class="r10">  321 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    merge_candidate_heap: </span><span class="r19">list</span><span class="r18">[MergeHeapEntry],</span><span class="r14">   </span>  
 <span class="r10">  322 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair_version: </span><span class="r19">dict</span><span class="r18">[MergePair, </span><span class="r19">int</span><span class="r18">],</span><span class="r14">           </span>  
 <span class="r10">  323 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">) </span><span class="r20">-&gt;</span><span class="r18"> MergePair </span><span class="r20">|</span><span class="r18"> </span><span class="r15">None</span><span class="r18">:</span><span class="r14">                            </span>  
 <span class="r10">  324 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Return the most frequent pair, or ``None`` </span>  
 <span class="r10">  325 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">while</span><span class="r18"> merge_candidate_heap:</span><span class="r14">                   </span>  
 <span class="r10">  326 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        neg_count, _, _, a, b, version </span><span class="r20">=</span><span class="r18"> heappop(m</span>  
 <span class="r10">  327 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">if</span><span class="r18"> neg_count </span><span class="r20">&lt;</span><span class="r18"> </span><span class="r20">0</span><span class="r18"> </span><span class="r24">and</span><span class="r18"> pair_version[a, b] </span><span class="r20">==</span>  
 <span class="r10">  328 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            </span><span class="r15">return</span><span class="r18"> a, b</span><span class="r14">                           </span>  
 <span class="r10">  329 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">return</span><span class="r18"> </span><span class="r15">None</span><span class="r14">                                   </span>  
 <span class="r10">  330 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  331 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  332 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">def</span><span class="r16"> </span><span class="r22">_apply_merge</span><span class="r18">(</span><span class="r14">                                 </span>  
 <span class="r10">  333 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    new_token_id: </span><span class="r19">int</span><span class="r18">,</span><span class="r14">                            </span>  
 <span class="r10">  334 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair: MergePair,</span><span class="r14">                              </span>  
 <span class="r10">  335 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair_to_tokens: </span><span class="r19">dict</span><span class="r18">[MergePair, </span><span class="r19">set</span><span class="r18">[</span><span class="r19">bytes</span><span class="r18">]],</span><span class="r14">  </span>  
 <span class="r10">  336 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pre_token_counts: Counter[</span><span class="r19">bytes</span><span class="r18">],</span><span class="r14">             </span>  
 <span class="r10">  337 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    token_splits: </span><span class="r19">dict</span><span class="r18">[</span><span class="r19">bytes</span><span class="r18">, TokenIdSplit],</span><span class="r14">      </span>  
 <span class="r10">  338 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair_counts: Counter[MergePair],</span><span class="r14">              </span>  
 <span class="r10">  339 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair_version: </span><span class="r19">dict</span><span class="r18">[MergePair, </span><span class="r19">int</span><span class="r18">],</span><span class="r14">           </span>  
 <span class="r10">  340 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    merge_candidate_heap: </span><span class="r19">list</span><span class="r18">[MergeHeapEntry],</span><span class="r14">   </span>  
 <span class="r10">  341 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    vocab_lexkey: Sequence[</span><span class="r19">tuple</span><span class="r18">[</span><span class="r19">int</span><span class="r18">, </span><span class="r20">...</span><span class="r18">]],</span><span class="r14">      </span>  
 <span class="r10">  342 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">):</span><span class="r14">                                                </span>  
 <span class="r10">  343 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">    </span><span class="r13">&quot;&quot;&quot;Merge the selected pair across all tokens a</span>  
 <span class="r10">  344 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    tokens </span><span class="r20">=</span><span class="r18"> pair_to_tokens[pair]</span><span class="r14">                 </span>  
 <span class="r10">  345 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    a, b </span><span class="r20">=</span><span class="r18"> pair</span><span class="r14">                                   </span>  
 <span class="r10">  346 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair_count_delta: Counter[MergePair] </span><span class="r20">=</span><span class="r18"> Counter</span>  
 <span class="r10">  347 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">for</span><span class="r18"> token </span><span class="r24">in</span><span class="r18"> </span><span class="r19">list</span><span class="r18">(tokens):</span><span class="r14">                    </span>  
 <span class="r10">  348 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        split: TokenIdSplit </span><span class="r20">=</span><span class="r18"> token_splits[token]</span><span class="r14"> </span>  
 <span class="r10">  349 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        freq </span><span class="r20">=</span><span class="r18"> pre_token_counts[token]</span><span class="r14">            </span>  
 <span class="r10">  350 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        new_split: TokenIdSplit </span><span class="r20">=</span><span class="r18"> []</span><span class="r14">              </span>  
 <span class="r10">  351 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        i </span><span class="r20">=</span><span class="r18"> </span><span class="r20">0</span><span class="r14">                                     </span>  
 <span class="r10">  352 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        n </span><span class="r20">=</span><span class="r18"> </span><span class="r19">len</span><span class="r18">(split)</span><span class="r14">                            </span>  
 <span class="r10">  353 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">while</span><span class="r18"> i </span><span class="r20">&lt;</span><span class="r18"> n:</span><span class="r14">                              </span>  
 <span class="r10">  354 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            </span><span class="r15">if</span><span class="r18"> i </span><span class="r20">+</span><span class="r18"> </span><span class="r20">1</span><span class="r18"> </span><span class="r20">&lt;</span><span class="r18"> n </span><span class="r24">and</span><span class="r18"> split[i] </span><span class="r20">==</span><span class="r18"> a </span><span class="r24">and</span><span class="r18"> spl</span>  
 <span class="r10">  355 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                prev </span><span class="r20">=</span><span class="r18"> split[i </span><span class="r20">-</span><span class="r18"> </span><span class="r20">1</span><span class="r18">] </span><span class="r15">if</span><span class="r18"> i </span><span class="r20">&gt;</span><span class="r18"> </span><span class="r20">0</span><span class="r18"> </span><span class="r15">else</span><span class="r18"> </span>  
 <span class="r10">  356 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                nxt </span><span class="r20">=</span><span class="r18"> split[i </span><span class="r20">+</span><span class="r18"> </span><span class="r20">2</span><span class="r18">] </span><span class="r15">if</span><span class="r18"> i </span><span class="r20">+</span><span class="r18"> </span><span class="r20">2</span><span class="r18"> </span><span class="r20">&lt;</span><span class="r18"> n </span><span class="r15">el</span>  
 <span class="r10">  357 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                </span><span class="r15">if</span><span class="r18"> prev </span><span class="r24">is</span><span class="r18"> </span><span class="r24">not</span><span class="r18"> </span><span class="r15">None</span><span class="r18">:</span><span class="r14">              </span>  
 <span class="r10">  358 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                    pair_count_delta[(prev, a)] </span><span class="r20">-=</span>  
 <span class="r10">  359 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                    pair_count_delta[(prev, new_to</span>  
 <span class="r10">  360 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                </span><span class="r15">if</span><span class="r18"> nxt </span><span class="r24">is</span><span class="r18"> </span><span class="r24">not</span><span class="r18"> </span><span class="r15">None</span><span class="r18">:</span><span class="r14">               </span>  
 <span class="r10">  361 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                    pair_count_delta[(b, nxt)] </span><span class="r20">-=</span><span class="r18"> </span>  
 <span class="r10">  362 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                    pair_count_delta[(new_token_id</span>  
 <span class="r10">  363 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                new_split</span><span class="r20">.</span><span class="r18">append(new_token_id)</span><span class="r14">    </span>  
 <span class="r10">  364 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                i </span><span class="r20">+=</span><span class="r18"> </span><span class="r20">2</span><span class="r14">                            </span>  
 <span class="r10">  365 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            </span><span class="r15">else</span><span class="r18">:</span><span class="r14">                                 </span>  
 <span class="r10">  366 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                new_split</span><span class="r20">.</span><span class="r18">append(split[i])</span><span class="r14">        </span>  
 <span class="r10">  367 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                i </span><span class="r20">+=</span><span class="r18"> </span><span class="r20">1</span><span class="r14">                            </span>  
 <span class="r10">  368 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        old_pairs </span><span class="r20">=</span><span class="r18"> {(split[i], split[i </span><span class="r20">+</span><span class="r18"> </span><span class="r20">1</span><span class="r18">]) </span><span class="r15">for</span><span class="r18"> </span>  
 <span class="r10">  369 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        new_pairs </span><span class="r20">=</span><span class="r18"> {(new_split[j], new_split[j </span><span class="r20">+</span><span class="r18"> </span>  
 <span class="r10">  370 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">for</span><span class="r18"> p </span><span class="r24">in</span><span class="r18"> new_pairs </span><span class="r20">-</span><span class="r18"> old_pairs:</span><span class="r14">           </span>  
 <span class="r10">  371 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            pair_to_tokens[p]</span><span class="r20">.</span><span class="r18">add(token)</span><span class="r14">          </span>  
 <span class="r10">  372 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">for</span><span class="r18"> p </span><span class="r24">in</span><span class="r18"> old_pairs </span><span class="r20">-</span><span class="r18"> new_pairs:</span><span class="r14">           </span>  
 <span class="r10">  373 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            pair_to_tokens[p]</span><span class="r20">.</span><span class="r18">discard(token)</span><span class="r14">      </span>  
 <span class="r10">  374 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        token_splits[token] </span><span class="r20">=</span><span class="r18"> new_split</span><span class="r14">           </span>  
 <span class="r10">  375 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  376 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair_counts</span><span class="r20">.</span><span class="r18">update(pair_count_delta)</span><span class="r14">          </span>  
 <span class="r10">  377 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair_counts[pair] </span><span class="r20">=</span><span class="r18"> </span><span class="r20">0</span><span class="r14">                         </span>  
 <span class="r10">  378 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  379 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r15">for</span><span class="r18"> a, b </span><span class="r24">in</span><span class="r18"> pair_count_delta:</span><span class="r14">                 </span>  
 <span class="r10">  380 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        freq </span><span class="r20">=</span><span class="r18"> pair_counts[a, b]</span><span class="r14">                  </span>  
 <span class="r10">  381 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        pair_version[a, b] </span><span class="r20">+=</span><span class="r18"> </span><span class="r20">1</span><span class="r18">  </span><span class="r25"># freq &lt;= 0, igno</span>  
 <span class="r10">  382 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        </span><span class="r15">if</span><span class="r18"> freq </span><span class="r20">&gt;</span><span class="r18"> </span><span class="r20">0</span><span class="r18">:</span><span class="r14">                              </span>  
 <span class="r10">  383 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            heappush(</span><span class="r14">                             </span>  
 <span class="r10">  384 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                merge_candidate_heap,</span><span class="r14">             </span>  
 <span class="r10">  385 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">                (</span><span class="r20">-</span><span class="r18">freq, vocab_lexkey[a], vocab_lex</span>  
 <span class="r10">  386 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">            )</span><span class="r14">                                     </span>  
 <span class="r10">  387 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    pair_version[pair] </span><span class="r20">+=</span><span class="r18"> </span><span class="r20">1</span><span class="r14">                       </span>  
 <span class="r10">  388 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  389 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  390 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r15">if</span><span class="r18"> </span><span class="r27">__name__</span><span class="r18"> </span><span class="r20">==</span><span class="r18"> </span><span class="r21">&quot;__main__&quot;</span><span class="r18">:</span><span class="r14">                        </span>  
 <span class="r10">  391 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r25"># test/debug</span><span class="r14">                                  </span>  
 <span class="r10">  392 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r25"># train_bpe(input_path=&quot;data/TinyStoriesV2-GPT</span>  
 <span class="r10">  393 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">  394 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    </span><span class="r25"># train</span><span class="r14">                                       </span>  
 <span class="r10">  395 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    bpe_result </span><span class="r20">=</span><span class="r18"> train_bpe(</span><span class="r14">                       </span>  
 <span class="r10">  396 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">        input_path</span><span class="r20">=</span><span class="r21">&quot;data/TinyStoriesV2-GPT4-train.</span>  
 <span class="r10">  397 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    )</span><span class="r14">                                             </span>  
 <span class="r10">  398 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">    print_bpe_result(bpe_result</span><span class="r20">=</span><span class="r18">bpe_result)</span><span class="r14">       </span>  
 <span class="r10">  399 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                                                  </span>  
 <span class="r10">      </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│                                                    
╶──────┼───────┼───────┼──────┼───────┼───────┼───────┼───────────────┼───────┼───────────────────────────────────────────────────╴
 <span class="r10">      </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r28">function summary for /home/luke/code/assignment1-…</span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">  2%   </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r18">find_chunk_boundaries</span><span class="r14">                             </span>  
 <span class="r10">  204 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">  1%   </span>│<span class="r1">  92%  </span>│<span class="r1">   10M </span>│<span class="r1">█              </span>│<span class="r12">     2 </span>│<span class="r18">_collect_pre_token_counts_from_ranges</span><span class="r14">             </span>  
 <span class="r10">  250 </span>│<span class="r26">   62%</span><span class="r11"> </span>│<span class="r26">   13%</span><span class="r11"> </span>│<span class="r11">  25% </span>│<span class="r26">  9%</span><span class="r12">   </span>│<span class="r1">  98%  </span>│<span class="r1">  774M </span>│<span class="r26">█████████ 100%</span><span class="r1"> </span>│<span class="r12">   117 </span>│<span class="r18">_process_range_for_pretokenization</span><span class="r14">                </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
Top PEAK memory consumption, by line:
<span class="r1">(1)   257:   774 MB</span>                                                                                                                 
<span class="r1">(2)   264:   200 MB</span>                                                                                                                 
<span class="r1">(3)   230:    10 MB</span>                                                                                                                 
generated by the <a class="r29" href="https://github.com/plasma-umass/scalene">scalene</a> profiler                                                                                                   
</code></pre>
</body>
</html>
